<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up</title>
    <style>
      /* Base styles */
      body {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      }

      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
      }

      /* Card styles */
      .card {
        width: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        border-top: 4px solid #77ba99;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Form styles */
      form {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        gap: 100px;
      }

      input {
        padding: 12px;
        font-size: medium;
        border: none;
        background-color: transparent;
        border-bottom: 1px solid #ccc;
        color: #333;
        width: 100%;
        margin-bottom: 15px;
      }

      input::placeholder {
        font-size: medium;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      }

      /* Select styles */
      .select-wrapper {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
      }

      select {
        width: 100%;
        padding: 10px 30px 10px 10px;
        border: none;
        border-bottom: 1px solid #ccc;
        background-color: transparent;
        cursor: pointer;
        color: #333;
        font-size: 1em;
        appearance: none;
        transition: all 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      }

      select option {
        color: #333;
      }

      select option[disabled] {
        color: #999;
      }

      /* Select arrow */
      .select-wrapper::after {
        content: "";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #77ba99;
        pointer-events: none;
        transition: transform 0.3s ease;
        z-index: 1;
      }

      .select-wrapper:hover::after {
        transform: translateY(-50%) scale(1.2);
      }

      /* Select states */
      select:focus {
        outline: none;
        border-bottom: 2px solid #77ba99;
      }

      select:hover {
        background-color: #f8f8f8;
      }

      /* Disabled state */
      select:disabled {
        color: #999;
        border-bottom: 1px dashed #ccc;
        cursor: not-allowed;
        opacity: 0.7;
      }

      .select-wrapper:has(select:disabled)::after {
        border-top-color: #ccc;
        opacity: 0.7;
      }

      /* Error state */
      select.error {
        border-bottom: 1px solid #ff6b6b;
      }

      .select-wrapper:has(select.error)::after {
        border-top-color: #ff6b6b;
      }

      /* Button styles */
      .buttons {
        margin-top: 25px;
        display: flex;
        justify-content: flex-start;
        gap: 10px;
      }

      .login-button {
        padding: 10px 20px;
        background-color: #77ba99;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .login-button:hover {
        background-color: #669982;
      }

      /* Error message */
      .error-message {
        color: red;
        font-size: 12px;
        margin-top: -10px;
        margin-bottom: 10px;
      }

      #mainError {
        color: red;
        text-align: center;
        margin-bottom: 15px;
        font-size: 14px;
      }

      #successMessage {
        color: #77ba99;
        text-align: center;
        margin-bottom: 15px;
        font-size: 14px;
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        form {
          flex-direction: column;
          gap: 20px;
        }

        .card {
          width: 90%;
          max-width: 400px;
          margin: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div id="mainError"></div>
        <div id="successMessage"></div>
        <form id="signupForm" method="post" action="createUser">
          <div class="part1">
            <input
              type="text"
              id="full_name"
              name="full_name"
              placeholder="Enter full name"
              required
            />
            <div id="full_nameError" class="error-message"></div>

            <input
              type="text"
              id="user_name"
              name="user_name"
              placeholder="Enter username"
              required
            />
            <div id="user_nameError" class="error-message"></div>

            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter password"
              required
            />
            <div id="passwordError" class="error-message"></div>

            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm password"
              required
            />
            <div id="confirmPasswordError" class="error-message"></div>

            <input
              type="tel"
              id="phone_number"
              name="phone_number"
              placeholder="Enter phone number"
              required
            />
            <div id="phone_numberError" class="error-message"></div>
            <!-- Corrected -->

            <div class="select-wrapper">
              <select id="role" name="role" required>
                <option value="" disabled selected>Select Role</option>
                <option value="student">Student</option>
                <option value="manager">Manager</option>
                <option value="teacher">Teacher</option>
                <option value="hod">Head of Department</option>
                <option value="librarian">Librarian</option>
              </select>
            </div>
            <div id="roleError" class="error-message"></div>

            <div class="select-wrapper">
              <select id="gender" name="gender" required>
                <option value="" disabled selected>Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div id="genderError" class="error-message"></div>

            <div class="buttons">
              <button type="submit" class="login-button">Register</button>
            </div>
          </div>

          <div class="part2">
            <div class="select-wrapper">
              <select id="province" name="province" required>
                <option value="" disabled selected>Select Province</option>
              </select>
            </div>
            <div id="provinceError" class="error-message"></div>

            <div class="select-wrapper">
              <select
                id="district"
                name="district"
                onchange="fetchSectors()"
                required
              >
                <option value="" disabled selected>Select District</option>
              </select>
            </div>
            <div id="districtError" class="error-message"></div>

            <div class="select-wrapper">
              <select
                id="sector"
                name="sector"
                onchange="fetchCells()"
                required
              >
                <option value="" disabled selected>Select Sector</option>
              </select>
            </div>
            <div id="sectorError" class="error-message"></div>

            <div class="select-wrapper">
              <select id="cell" name="cell" onchange="fetchVillages()" required>
                <option value="" disabled selected>Select Cell</option>
              </select>
            </div>
            <div id="cellError" class="error-message"></div>

            <div class="select-wrapper">
              <select id="village" name="village" required>
                <option value="" disabled selected>Select Village</option>
              </select>
            </div>
            <div id="villageError" class="error-message"></div>
          </div>
        </form>
      </div>
    </div>
  </body>

  <script>
    const API_URL = "https://rwanda.p.rapidapi.com";
    const API_HEADERS = {
      "x-rapidapi-key": "2199840b10msh703983e3fedcdb6p1d3842jsn70a2ff40d543",
      "x-rapidapi-host": "rwanda.p.rapidapi.com",
    };

    // Form validation patterns
    const PATTERNS = {
      phone: /^(\+?250|0)?[67][0-9]{8}$/,
      password: /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/,
      username: /^[a-zA-Z0-9_]{3,20}$/,
    };

    // Error messages
    const ERROR_MESSAGES = {
      phone: "Please enter a valid Rwanda phone number (e.g., +250781234567)",
      password:
        "Password must be at least 8 characters with letters and numbers",
      username:
        "Username must be 3-20 characters, using only letters, numbers, and underscore",
      fullName: "Please enter both first and last name",
      passwordMatch: "Passwords do not match",
      required: "This field is required",
    };

    document.addEventListener("DOMContentLoaded", () => {
      // Initialize form
      initializeForm();
      // Fetch initial data
      fetchProvinces();
    });

    function initializeForm() {
      setupFormValidation();
      setupDropdowns();
    }

    function setupFormValidation() {
      const form = document.getElementById("signupForm"); // Ensure you get the form here
      const inputs = form.querySelectorAll("input, select");

      // Add validation to all inputs
      inputs.forEach((input) => {
        input.addEventListener("input", () => validateField(input));
        input.addEventListener("blur", () => validateField(input));
      });

      // Add form submit handler
      form.addEventListener("submit", handleSubmit); // Bind the handleSubmit function here
    }

    function setupDropdowns() {
      // Set up change handlers for location dropdowns
      document.getElementById("province").addEventListener("change", () => {
        fetchDistricts();
        clearDropdowns(["district", "sector", "cell", "village"]);
      });

      document.getElementById("district").addEventListener("change", () => {
        fetchSectors();
        clearDropdowns(["sector", "cell", "village"]);
      });

      document.getElementById("sector").addEventListener("change", () => {
        fetchCells();
        clearDropdowns(["cell", "village"]);
      });

      document.getElementById("cell").addEventListener("change", () => {
        fetchVillages();
        clearDropdowns(["village"]);
      });
    }

    function validateField(input) {
      const errorElement = document.getElementById(`${input.id}Error`);
      let isValid = true;
      let errorMessage = "";

      // Clear previous error if the error element exists
      if (errorElement) {
        errorElement.textContent = "";
      }

      // Required field validation
      if (input.required && !input.value) {
        isValid = false;
        errorMessage = ERROR_MESSAGES.required;
      }

      // Pattern validation for specific fields
      switch (input.id) {
        case "phone_number":
          if (input.value && !PATTERNS.phone.test(input.value)) {
            isValid = false;
            errorMessage = ERROR_MESSAGES.phone;
          }
          break;

        case "confirmPassword":
          const password = document.getElementById("password").value;
          if (input.value && input.value !== password) {
            isValid = false;
            errorMessage = ERROR_MESSAGES.passwordMatch;
          }
          break;

        case "user_name":
          if (input.value && !PATTERNS.username.test(input.value)) {
            isValid = false;
            errorMessage = ERROR_MESSAGES.username;
          }
          break;

        case "full_name":
          if (input.value && input.value.trim().split(/\s+/).length < 2) {
            isValid = false;
            errorMessage = ERROR_MESSAGES.fullName;
          }
          break;
      }

      // Show error message if validation failed
      if (!isValid && errorElement) {
        errorElement.textContent = errorMessage;
      }

      return isValid;
    }

    async function handleSubmit(event) {
      event.preventDefault(); // Prevent the default form submission
      const form = event.target; // Get the form from the event
      const inputs = form.querySelectorAll("input, select");
      let isFormValid = true;

      // Validate all fields
      inputs.forEach((input) => {
        const isValid = validateField(input);
        if (!isValid) isFormValid = false;
      });

      if (isFormValid) {
        const formData = new FormData(form);
        const fullName = formData.get("full_name") || "";
        const [first_name, last_name] = fullName.split(" ");

        formData.set("first_name", first_name || "");
        formData.set("last_name", last_name || "");

        formData.delete("full_name");

        const userData = Object.fromEntries(formData.entries());
        document.getElementById("mainError").textContent = "";

        try {
          const response = await fetch(form.action, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          });

          if (response.ok) {
            document.getElementById("successMessage").textContent =
              "Registration successful!";
            // setTimeout(() => {
            //   window.location.href = "./";
            // }, 2000);
            // form.reset(); 
          } else {
            const error = await response.json();
            document.getElementById("mainError").textContent =
              error.message || "An error occurred.";
          }
        } catch (error) {
          document.getElementById("mainError").textContent =
            "Failed to submit form. Please try again.";
        }
      } else {
        document.getElementById("mainError").textContent =
          "Please correct the highlighted fields.";
      }
    }

    async function fetchProvinces() {
      try {
        const response = await fetch(`${API_URL}/provinces`, {
          headers: API_HEADERS,
        });
        const data = await response.json();
        populateDropdown("province", data?.data);
      } catch (error) {
        console.error("Error fetching provinces:", error);
      }
    }

    async function fetchDistricts() {
      const province = document.getElementById("province").value;
      try {
        const response = await fetch(`${API_URL}/districts?p=${province}`, {
          headers: API_HEADERS,
        });
        const data = await response.json();
        populateDropdown("district", data?.data);
      } catch (error) {
        console.error("Error fetching districts:", error);
      }
    }

    async function fetchSectors() {
      const province = document.getElementById("province").value;
      const district = document.getElementById("district").value;
      try {
        const response = await fetch(
          `${API_URL}/sectors?p=${province}&d=${district}`,
          { headers: API_HEADERS }
        );
        const data = await response.json();
        populateDropdown("sector", data?.data);
      } catch (error) {
        console.error("Error fetching sectors:", error);
      }
    }

    async function fetchCells() {
      const province = document.getElementById("province").value;
      const district = document.getElementById("district").value;
      const sector = document.getElementById("sector").value;
      try {
        const response = await fetch(
          `${API_URL}/cells?p=${province}&d=${district}&s=${sector}`,
          { headers: API_HEADERS }
        );
        const data = await response.json();
        populateDropdown("cell", data?.data);
      } catch (error) {
        console.error("Error fetching cells:", error);
      }
    }

    async function fetchVillages() {
      const province = document.getElementById("province").value;
      const district = document.getElementById("district").value;
      const sector = document.getElementById("sector").value;
      const cell = document.getElementById("cell").value;
      try {
        const response = await fetch(
          `${API_URL}/villages?p=${province}&d=${district}&s=${sector}&c=${cell}`,
          { headers: API_HEADERS }
        );
        const data = await response.json();
        populateDropdown("village", data?.data);
      } catch (error) {
        console.error("Error fetching villages:", error);
      }
    }

    function populateDropdown(id, items) {
      const dropdown = document.getElementById(id);
      dropdown.innerHTML = '<option value="">Select</option>';
      items.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.toLowerCase();
        option.textContent = item;
        dropdown.appendChild(option);
      });
    }

    function clearDropdowns(dropdownIds) {
      dropdownIds.forEach((id) => {
        const selectElement = document.getElementById(id);
        selectElement.innerHTML = `<option value="" disabled selected>Select ${
          selectElement.id.charAt(0).toUpperCase() + selectElement.id.slice(1)
        }</option>`;
      });
    }
  </script>
</html>
